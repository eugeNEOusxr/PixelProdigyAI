<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Building Library - Professional Architecture Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            overflow: hidden;
        }

        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
            max-width: 350px;
            z-index: 100;
        }

        #info h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #4CAF50;
        }

        #info p {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            color: white;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 100;
        }

        .controls h2 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .building-category {
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 15px;
        }

        .building-category h3 {
            color: #64B5F6;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .building-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .building-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .building-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .building-btn:active {
            transform: translateY(0);
        }

        .action-buttons {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .action-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: #45a049;
        }

        .clear-btn {
            background: #f44336;
        }

        .clear-btn:hover {
            background: #da190b;
        }

        .export-btn {
            background: #2196F3;
        }

        .export-btn:hover {
            background: #0b7dda;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
        }

        .stats {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 100;
        }

        .stats div {
            margin: 5px 0;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }
    </style>
</head>
<body>
    <div id="info">
        <h1>üèõÔ∏è College Building Library</h1>
        <p><strong>Professional Architecture Generator</strong></p>
        <p>Click any building type to instantly generate realistic college architecture. All buildings include proper materials, lighting, and can be exported for your game.</p>
        <p><strong>Controls:</strong><br>
        üéÆ <strong>W/A/S/D</strong> - Walk Around<br>
        üéÆ <strong>Space</strong> - Jump / Fly Up<br>
        üéÆ <strong>Shift</strong> - Crouch / Fly Down<br>
        üñ±Ô∏è <strong>Mouse Move</strong> - Look Around<br>
        üñ±Ô∏è <strong>Scroll Wheel</strong> - Zoom View</p>
        <p><strong>Interior Features:</strong><br>
        ü™ë Desks, Chairs & Whiteboards<br>
        üìö Bookshelves & Libraries<br>
        üõãÔ∏è Sofas & Waiting Areas<br>
        üß™ Lab Equipment & Computers</p>
    </div>

    <div class="controls">
        <h2>Building Library</h2>
        
        <div class="building-category">
            <h3>üìö Academic Buildings</h3>
            <div class="building-grid">
                <button class="building-btn" onclick="addBuilding('library')">Library</button>
                <button class="building-btn" onclick="addBuilding('science')">Science Lab</button>
                <button class="building-btn" onclick="addBuilding('lecture')">Lecture Hall</button>
                <button class="building-btn" onclick="addBuilding('computer')">Computer Lab</button>
                <button class="building-btn" onclick="addBuilding('arts')">Arts Building</button>
                <button class="building-btn" onclick="addBuilding('engineering')">Engineering</button>
            </div>
        </div>

        <div class="building-category">
            <h3>üè¢ Administrative Buildings</h3>
            <div class="building-grid">
                <button class="building-btn" onclick="addBuilding('admin')">Admin Center</button>
                <button class="building-btn" onclick="addBuilding('student_services')">Student Services</button>
                <button class="building-btn" onclick="addBuilding('admissions')">Admissions Office</button>
                <button class="building-btn" onclick="addBuilding('financial')">Financial Aid</button>
            </div>
        </div>

        <div class="building-category">
            <h3>üé≠ Student Life Buildings</h3>
            <div class="building-grid">
                <button class="building-btn" onclick="addBuilding('cafeteria')">Cafeteria</button>
                <button class="building-btn" onclick="addBuilding('student_union')">Student Union</button>
                <button class="building-btn" onclick="addBuilding('theater')">Theater</button>
                <button class="building-btn" onclick="addBuilding('gym')">Gymnasium</button>
                <button class="building-btn" onclick="addBuilding('dorm')">Dormitory</button>
                <button class="building-btn" onclick="addBuilding('bookstore')">Bookstore</button>
            </div>
        </div>

        <div class="building-category">
            <h3>‚öôÔ∏è Facilities</h3>
            <div class="building-grid">
                <button class="building-btn" onclick="addBuilding('maintenance')">Maintenance</button>
                <button class="building-btn" onclick="addBuilding('parking')">Parking Structure</button>
                <button class="building-btn" onclick="addBuilding('security')">Security Office</button>
                <button class="building-btn" onclick="addBuilding('greenhouse')">Greenhouse</button>
            </div>
        </div>

        <div class="building-category">
            <h3>üèõÔ∏è Special Buildings</h3>
            <div class="building-grid">
                <button class="building-btn" onclick="addBuilding('clock_tower')">Clock Tower</button>
                <button class="building-btn" onclick="addBuilding('fountain')">Fountain Plaza</button>
                <button class="building-btn" onclick="addBuilding('auditorium')">Auditorium</button>
                <button class="building-btn" onclick="addBuilding('chapel')">Chapel</button>
            </div>
        </div>

        <div class="action-buttons">
            <button class="action-btn" onclick="generateFullCampus()">üè´ Generate Full Campus</button>
            <button class="action-btn export-btn" onclick="exportScene()">üíæ Export All Buildings</button>
            <button class="action-btn clear-btn" onclick="clearScene()">üóëÔ∏è Clear Scene</button>
        </div>
    </div>

    <div class="stats">
        <div><strong>Buildings:</strong> <span id="building-count">0</span></div>
        <div><strong>Vertices:</strong> <span id="vertex-count">0</span></div>
        <div><strong>Triangles:</strong> <span id="triangle-count">0</span></div>
    </div>

    <div id="canvas-container"></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.152.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.152.0/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        
        // Make THREE global so it's accessible everywhere
        window.THREE = THREE;

        // Scene Setup
        let scene, camera, renderer;
        let buildings = [];
        
        // First-Person Controls
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let moveUp = false, moveDown = false;
        let velocity = new THREE.Vector3();
        let direction = new THREE.Vector3();
        let rotation = { x: 0, y: 0 };
        let isPointerLocked = false;
        const moveSpeed = 0.5;
        const lookSpeed = 0.002;

        // Building Templates with Professional Architecture
        const buildingTemplates = {
            library: {
                name: "Library",
                width: 50, depth: 40, height: 30,
                floors: 3,
                color: 0xd4a574,
                features: ['columns', 'large_windows', 'entrance_steps', 'roof_detail', 'interior', 'library_furniture'],
                windowPattern: 'academic',
                roofType: 'flat_modern',
                interior: {
                    floorType: 'marble',
                    wallType: 'paneling',
                    hasStairs: true,
                    hasElevator: false,
                    roomType: 'library'
                }
            },
            science: {
                name: "Science Lab",
                width: 45, depth: 45, height: 35,
                floors: 3,
                color: 0xb8b8b8,
                features: ['modern_facade', 'lab_windows', 'ventilation', 'interior', 'lab_furniture'],
                windowPattern: 'modern_grid',
                roofType: 'flat_industrial',
                interior: {
                    floorType: 'tile',
                    wallType: 'modern',
                    hasStairs: true,
                    hasElevator: true,
                    roomType: 'science_lab'
                }
            },
            lecture: {
                name: "Lecture Hall",
                width: 60, depth: 40, height: 25,
                floors: 2,
                color: 0xc19a6b,
                features: ['amphitheater_design', 'large_entrance', 'tiered_interior', 'interior', 'classroom_furniture'],
                windowPattern: 'minimal',
                roofType: 'sloped',
                interior: {
                    floorType: 'carpet',
                    wallType: 'acoustic',
                    hasStairs: true,
                    hasElevator: false,
                    roomType: 'lecture'
                }
            },
            computer: {
                name: "Computer Lab",
                width: 45, depth: 30, height: 18,
                floors: 2,
                color: 0x9e9e9e,
                features: ['modern_tech', 'glass_facade', 'server_room', 'interior', 'computer_furniture'],
                windowPattern: 'modern_grid',
                roofType: 'flat_modern',
                interior: {
                    floorType: 'tile',
                    wallType: 'modern',
                    hasStairs: true,
                    hasElevator: false,
                    roomType: 'computer_lab'
                }
            },
            arts: {
                name: "Arts Building",
                width: 35, depth: 35, height: 22,
                floors: 2,
                color: 0xe8d4a0,
                features: ['skylights', 'gallery_space', 'studio_windows', 'interior'],
                windowPattern: 'artistic',
                roofType: 'skylight_grid',
                interior: {
                    floorType: 'polished_concrete',
                    wallType: 'gallery',
                    hasStairs: true,
                    hasElevator: false
                }
            },
            engineering: {
                name: "Engineering Building",
                width: 50, depth: 40, height: 35,
                floors: 4,
                color: 0xa8a8a8,
                features: ['industrial_design', 'workshop_bays', 'loading_dock', 'interior'],
                windowPattern: 'industrial',
                roofType: 'flat_industrial',
                interior: {
                    floorType: 'industrial',
                    wallType: 'concrete',
                    hasStairs: true,
                    hasElevator: true
                }
            },
            admin: {
                name: "Administration Center",
                width: 38, depth: 28, height: 28,
                floors: 3,
                color: 0xdab894,
                features: ['formal_entrance', 'columns', 'executive_design', 'interior'],
                windowPattern: 'formal',
                roofType: 'peaked',
                interior: {
                    floorType: 'marble',
                    wallType: 'wood_paneling',
                    hasStairs: true,
                    hasElevator: true
                }
            },
            student_services: {
                name: "Student Services",
                width: 45, depth: 35, height: 22,
                floors: 2,
                color: 0xc8b896,
                features: ['accessible_entrance', 'open_floor_plan', 'waiting_areas', 'interior', 'office_furniture'],
                windowPattern: 'welcoming',
                roofType: 'flat_modern',
                interior: {
                    floorType: 'tile',
                    wallType: 'modern',
                    hasStairs: true,
                    hasElevator: true,
                    roomType: 'office'
                }
            },
            admissions: {
                name: "Admissions Office",
                width: 25, depth: 20, height: 15,
                floors: 2,
                color: 0xd8c8a8,
                features: ['welcoming_entrance', 'reception_area', 'interior'],
                windowPattern: 'formal',
                roofType: 'flat_modern',
                interior: {
                    floorType: 'tile',
                    wallType: 'modern',
                    hasStairs: true,
                    hasElevator: false
                }
            },
            financial: {
                name: "Financial Aid Office",
                width: 22, depth: 18, height: 12,
                floors: 1,
                color: 0xc8b896,
                features: ['secure_entrance', 'office_layout', 'interior'],
                windowPattern: 'office',
                roofType: 'flat',
                interior: {
                    floorType: 'carpet',
                    wallType: 'office',
                    hasStairs: false,
                    hasElevator: false
                }
            },
            cafeteria: {
                name: "Cafeteria",
                width: 45, depth: 35, height: 18,
                floors: 1,
                color: 0xe8d8c8,
                features: ['large_windows', 'outdoor_seating', 'kitchen_area', 'interior'],
                windowPattern: 'full_glass',
                roofType: 'flat_modern',
                interior: {
                    floorType: 'tile',
                    wallType: 'modern',
                    hasStairs: false,
                    hasElevator: false
                }
            },
            student_union: {
                name: "Student Union",
                width: 50, depth: 45, height: 25,
                floors: 3,
                color: 0xd8c8b8,
                features: ['multi_purpose', 'social_spaces', 'food_court', 'interior'],
                windowPattern: 'modern_mixed',
                roofType: 'complex_modern',
                interior: {
                    floorType: 'polished_concrete',
                    wallType: 'modern',
                    hasStairs: true,
                    hasElevator: true
                }
            },
            theater: {
                name: "Theater",
                width: 40, depth: 50, height: 30,
                floors: 2,
                color: 0xa88860,
                features: ['curved_roof', 'stage_tower', 'lobby', 'interior'],
                windowPattern: 'minimal',
                roofType: 'curved_theatrical',
                interior: {
                    floorType: 'carpet',
                    wallType: 'acoustic',
                    hasStairs: true,
                    hasElevator: false
                }
            },
            gym: {
                name: "Gymnasium",
                width: 60, depth: 45, height: 25,
                floors: 1,
                color: 0xb8a898,
                features: ['high_ceiling', 'large_doors', 'bleachers', 'interior'],
                windowPattern: 'high_windows',
                roofType: 'arched',
                interior: {
                    floorType: 'hardwood',
                    wallType: 'gym',
                    hasStairs: false,
                    hasElevator: false
                }
            },
            dorm: {
                name: "Dormitory",
                width: 35, depth: 20, height: 40,
                floors: 5,
                color: 0xc8b8a8,
                features: ['residential', 'balconies', 'common_areas', 'interior'],
                windowPattern: 'residential',
                roofType: 'flat_modern',
                interior: {
                    floorType: 'carpet',
                    wallType: 'residential',
                    hasStairs: true,
                    hasElevator: true
                }
            },
            bookstore: {
                name: "Bookstore",
                width: 28, depth: 22, height: 15,
                floors: 2,
                color: 0xd8c8b8,
                features: ['retail_entrance', 'display_windows', 'storage', 'interior'],
                windowPattern: 'storefront',
                roofType: 'flat',
                interior: {
                    floorType: 'tile',
                    wallType: 'retail',
                    hasStairs: true,
                    hasElevator: false
                }
            },
            maintenance: {
                name: "Maintenance Building",
                width: 30, depth: 25, height: 12,
                floors: 1,
                color: 0x909090,
                features: ['garage_doors', 'workshop', 'storage_yard'],
                windowPattern: 'minimal',
                roofType: 'flat_industrial',
                interior: {
                    floorType: 'concrete',
                    wallType: 'industrial',
                    hasStairs: false,
                    hasElevator: false
                }
            },
            parking: {
                name: "Parking Structure",
                width: 60, depth: 40, height: 30,
                floors: 5,
                color: 0xa0a0a0,
                features: ['open_sides', 'ramps', 'parking_levels'],
                windowPattern: 'open_structure',
                roofType: 'flat',
                interior: {
                    floorType: 'concrete',
                    wallType: 'concrete',
                    hasStairs: true,
                    hasElevator: true
                }
            },
            security: {
                name: "Security Office",
                width: 15, depth: 12, height: 10,
                floors: 1,
                color: 0x888888,
                features: ['monitoring_room', 'secure_entrance', 'interior'],
                windowPattern: 'security',
                roofType: 'flat',
                interior: {
                    floorType: 'tile',
                    wallType: 'office',
                    hasStairs: false,
                    hasElevator: false
                }
            },
            greenhouse: {
                name: "Greenhouse",
                width: 25, depth: 20, height: 15,
                floors: 1,
                color: 0xc8f0c8,
                features: ['glass_structure', 'climate_control', 'growing_beds'],
                windowPattern: 'full_glass',
                roofType: 'glass_arched',
                interior: {
                    floorType: 'dirt',
                    wallType: 'glass',
                    hasStairs: false,
                    hasElevator: false
                }
            },
            clock_tower: {
                name: "Clock Tower",
                width: 12, depth: 12, height: 50,
                floors: 5,
                color: 0xd8c8a8,
                features: ['tower_design', 'clock_faces', 'observation_deck', 'interior'],
                windowPattern: 'tower',
                roofType: 'spire',
                interior: {
                    floorType: 'stone',
                    wallType: 'stone',
                    hasStairs: true,
                    hasElevator: false
                }
            },
            fountain: {
                name: "Fountain Plaza",
                width: 30, depth: 30, height: 5,
                floors: 0,
                color: 0x4a8ab0,
                features: ['water_feature', 'seating', 'landscaping'],
                windowPattern: 'none',
                roofType: 'none'
            },
            auditorium: {
                name: "Auditorium",
                width: 55, depth: 45, height: 35,
                floors: 3,
                color: 0xb89860,
                features: ['grand_entrance', 'balcony', 'stage_area', 'interior'],
                windowPattern: 'minimal',
                roofType: 'domed',
                interior: {
                    floorType: 'carpet',
                    wallType: 'acoustic',
                    hasStairs: true,
                    hasElevator: true
                }
            },
            chapel: {
                name: "Chapel",
                width: 25, depth: 40, height: 30,
                floors: 1,
                color: 0xd8c8b0,
                features: ['steeple', 'stained_glass', 'sanctuary', 'interior'],
                windowPattern: 'gothic',
                roofType: 'steeple',
                interior: {
                    floorType: 'stone',
                    wallType: 'stone',
                    hasStairs: false,
                    hasElevator: false
                }
            }
        };

        function init() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.Fog(0x87CEEB, 100, 500);

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 20);
            camera.rotation.order = 'YXZ';

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // First-Person Controls Setup
            setupFirstPersonControls();

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);

            const sunLight = new THREE.DirectionalLight(0xffffee, 1.0);
            sunLight.position.set(50, 80, 30);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 2048;
            sunLight.shadow.mapSize.height = 2048;
            sunLight.shadow.camera.left = -100;
            sunLight.shadow.camera.right = 100;
            sunLight.shadow.camera.top = 100;
            sunLight.shadow.camera.bottom = -100;
            sunLight.shadow.camera.near = 0.5;
            sunLight.shadow.camera.far = 200;
            sunLight.shadow.bias = -0.001;
            scene.add(sunLight);

            const fillLight = new THREE.DirectionalLight(0xaaccff, 0.3);
            fillLight.position.set(-30, 40, -30);
            scene.add(fillLight);

            // Ground
            const groundGeometry = new THREE.PlaneGeometry(500, 500);
            const groundMaterial = new THREE.MeshStandardMaterial({
                color: 0x4a7c3f,
                roughness: 0.9,
                metalness: 0.0
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // Grid helper
            const gridHelper = new THREE.GridHelper(500, 50, 0x888888, 0x444444);
            scene.add(gridHelper);

            // Window resize
            window.addEventListener('resize', onWindowResize);

            // Start animation
            animate();

            console.log('College Building Library Initialized');
        }

        function setupFirstPersonControls() {
            // Keyboard controls
            document.addEventListener('keydown', (event) => {
                switch (event.code) {
                    case 'KeyW': moveForward = true; break;
                    case 'KeyS': moveBackward = true; break;
                    case 'KeyA': moveLeft = true; break;
                    case 'KeyD': moveRight = true; break;
                    case 'Space': moveUp = true; break;
                    case 'ShiftLeft': moveDown = true; break;
                }
            });

            document.addEventListener('keyup', (event) => {
                switch (event.code) {
                    case 'KeyW': moveForward = false; break;
                    case 'KeyS': moveBackward = false; break;
                    case 'KeyA': moveLeft = false; break;
                    case 'KeyD': moveRight = false; break;
                    case 'Space': moveUp = false; break;
                    case 'ShiftLeft': moveDown = false; break;
                }
            });

            // Mouse look controls
            renderer.domElement.addEventListener('click', () => {
                renderer.domElement.requestPointerLock();
            });

            document.addEventListener('pointerlockchange', () => {
                isPointerLocked = document.pointerLockElement === renderer.domElement;
            });

            document.addEventListener('mousemove', (event) => {
                if (isPointerLocked) {
                    rotation.y -= event.movementX * lookSpeed;
                    rotation.x -= event.movementY * lookSpeed;
                    rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, rotation.x));
                }
            });

            // Mouse wheel zoom
            renderer.domElement.addEventListener('wheel', (event) => {
                event.preventDefault();
                // This can be used for FOV zoom if needed
            });
        }

        function updateFirstPersonMovement() {
            // Apply rotation
            camera.rotation.y = rotation.y;
            camera.rotation.x = rotation.x;

            // Calculate movement direction
            direction.set(0, 0, 0);

            if (moveForward) direction.z -= 1;
            if (moveBackward) direction.z += 1;
            if (moveLeft) direction.x -= 1;
            if (moveRight) direction.x += 1;
            if (moveUp) direction.y += 1;
            if (moveDown) direction.y -= 1;

            // Normalize and apply movement
            if (direction.length() > 0) {
                direction.normalize();
                
                // Transform direction based on camera rotation
                const forward = new THREE.Vector3(0, 0, -1);
                forward.applyQuaternion(camera.quaternion);
                forward.y = 0; // Keep movement horizontal
                forward.normalize();

                const right = new THREE.Vector3(1, 0, 0);
                right.applyQuaternion(camera.quaternion);
                right.y = 0;
                right.normalize();

                velocity.set(0, 0, 0);
                velocity.addScaledVector(forward, direction.z * moveSpeed);
                velocity.addScaledVector(right, direction.x * moveSpeed);
                velocity.y = direction.y * moveSpeed; // Vertical movement

                camera.position.add(velocity);
            }
        }

        function createBuilding(template, position = new THREE.Vector3(0, 0, 0)) {
            const group = new THREE.Group();
            group.position.copy(position);

            // Main building structure
            const buildingGeometry = new THREE.BoxGeometry(template.width, template.height, template.depth);
            const buildingMaterial = new THREE.MeshStandardMaterial({
                color: template.color,
                roughness: 0.8,
                metalness: 0.1
            });
            const buildingMesh = new THREE.Mesh(buildingGeometry, buildingMaterial);
            buildingMesh.position.y = template.height / 2;
            buildingMesh.castShadow = true;
            buildingMesh.receiveShadow = true;
            group.add(buildingMesh);

            // Add interior if specified
            if (template.interior && template.features.includes('interior')) {
                addInterior(group, template);
            }

            // Add windows based on pattern
            addWindows(group, template);

            // Add entrance
            addEntrance(group, template);

            // Add roof details
            addRoof(group, template);

            // Add special features
            if (template.features.includes('columns')) {
                addColumns(group, template);
            }

            buildings.push({
                group: group,
                template: template,
                position: position
            });

            scene.add(group);
            updateStats();

            return group;
        }

        function addInterior(group, template) {
            // Get floor material based on type
            function getFloorMaterial(floorType) {
                switch (floorType) {
                    case 'marble':
                        return new THREE.MeshStandardMaterial({
                            color: 0xd4d4d4,
                            roughness: 0.2,
                            metalness: 0.8,
                            map: createMarbleTexture()
                        });
                    case 'tile':
                        return new THREE.MeshStandardMaterial({
                            color: 0xe8e8e8,
                            roughness: 0.3,
                            metalness: 0.1,
                            map: createTileTexture()
                        });
                    case 'hardwood':
                        return new THREE.MeshStandardMaterial({
                            color: 0x8b4513,
                            roughness: 0.6,
                            metalness: 0.0,
                            map: createWoodTexture()
                        });
                    case 'carpet':
                        return new THREE.MeshStandardMaterial({
                            color: 0x8b6f47,
                            roughness: 0.9,
                            metalness: 0.0
                        });
                    case 'polished_concrete':
                        return new THREE.MeshStandardMaterial({
                            color: 0x909090,
                            roughness: 0.4,
                            metalness: 0.3
                        });
                    case 'stone':
                        return new THREE.MeshStandardMaterial({
                            color: 0x808080,
                            roughness: 0.8,
                            metalness: 0.0
                        });
                    case 'concrete':
                        return new THREE.MeshStandardMaterial({
                            color: 0x707070,
                            roughness: 0.9,
                            metalness: 0.0
                        });
                    case 'dirt':
                        return new THREE.MeshStandardMaterial({
                            color: 0x8b4513,
                            roughness: 1.0,
                            metalness: 0.0
                        });
                    default:
                        return new THREE.MeshStandardMaterial({
                            color: 0xcccccc,
                            roughness: 0.5,
                            metalness: 0.0
                        });
                }
            }

            // Get wall material based on type
            function getWallMaterial(wallType) {
                switch (wallType) {
                    case 'paneling':
                    case 'wood_paneling':
                        return new THREE.MeshStandardMaterial({
                            color: 0x8b6f47,
                            roughness: 0.7,
                            metalness: 0.0,
                            map: createWoodPanelingTexture()
                        });
                    case 'modern':
                        return new THREE.MeshStandardMaterial({
                            color: 0xf5f5f5,
                            roughness: 0.5,
                            metalness: 0.1
                        });
                    case 'acoustic':
                        return new THREE.MeshStandardMaterial({
                            color: 0x8b8b8b,
                            roughness: 0.8,
                            metalness: 0.0
                        });
                    case 'gallery':
                        return new THREE.MeshStandardMaterial({
                            color: 0xffffff,
                            roughness: 0.3,
                            metalness: 0.0
                        });
                    case 'concrete':
                        return new THREE.MeshStandardMaterial({
                            color: 0x808080,
                            roughness: 0.8,
                            metalness: 0.0
                        });
                    case 'office':
                        return new THREE.MeshStandardMaterial({
                            color: 0xe8e8e8,
                            roughness: 0.6,
                            metalness: 0.0
                        });
                    case 'stone':
                        return new THREE.MeshStandardMaterial({
                            color: 0x909090,
                            roughness: 0.7,
                            metalness: 0.0
                        });
                    default:
                        return new THREE.MeshStandardMaterial({
                            color: 0xe0e0e0,
                            roughness: 0.6,
                            metalness: 0.0
                        });
                }
            }

            const floorHeight = template.height / Math.max(template.floors, 1);
            const wallThickness = 0.3;

            // Create floors and interior walls for each level
            for (let floor = 0; floor < template.floors; floor++) {
                const y = floor * floorHeight;

                // Floor
                const floorGeometry = new THREE.BoxGeometry(
                    template.width - 2,
                    0.5,
                    template.depth - 2
                );
                const floorMaterial = getFloorMaterial(template.interior.floorType);
                const floorMesh = new THREE.Mesh(floorGeometry, floorMaterial);
                floorMesh.position.set(0, y + 0.25, 0);
                floorMesh.receiveShadow = true;
                group.add(floorMesh);

                // Interior walls (dividing rooms)
                if (floor < template.floors) {
                    const wallMaterial = getWallMaterial(template.interior.wallType);
                    
                    // Create corridor walls
                    const numRooms = Math.floor(template.width / 8);
                    for (let i = 1; i < numRooms; i++) {
                        const xPos = (i - numRooms / 2) * 8;
                        
                        // Vertical wall
                        const wallGeometry = new THREE.BoxGeometry(
                            wallThickness,
                            floorHeight - 1,
                            template.depth - 4
                        );
                        const wall = new THREE.Mesh(wallGeometry, wallMaterial);
                        wall.position.set(xPos, y + floorHeight / 2, 0);
                        wall.castShadow = true;
                        wall.receiveShadow = true;
                        group.add(wall);
                    }

                    // Add edge trim/molding
                    const trimMaterial = new THREE.MeshStandardMaterial({
                        color: 0xffffff,
                        roughness: 0.4,
                        metalness: 0.1
                    });

                    const trimGeometry = new THREE.BoxGeometry(
                        template.width - 1.5,
                        0.2,
                        0.2
                    );
                    
                    // Floor trim
                    const floorTrim = new THREE.Mesh(trimGeometry, trimMaterial);
                    floorTrim.position.set(0, y + 0.1, template.depth / 2 - 1.5);
                    group.add(floorTrim);

                    // Ceiling trim
                    const ceilingTrim = new THREE.Mesh(trimGeometry, trimMaterial);
                    ceilingTrim.position.set(0, y + floorHeight - 0.1, template.depth / 2 - 1.5);
                    group.add(ceilingTrim);
                }
            }

            // Add stairs if needed
            if (template.interior.hasStairs && template.floors > 1) {
                addStaircase(group, template, floorHeight);
            }

            // Add elevator if needed
            if (template.interior.hasElevator && template.floors > 1) {
                addElevator(group, template, floorHeight);
            }

            // Add furniture based on room type
            if (template.features.includes('classroom_furniture')) {
                addClassroomFurniture(group, template, floorHeight);
            }
            if (template.features.includes('library_furniture')) {
                addLibraryFurniture(group, template, floorHeight);
            }
            if (template.features.includes('lab_furniture')) {
                addLabFurniture(group, template, floorHeight);
            }
            if (template.features.includes('computer_furniture')) {
                addComputerLabFurniture(group, template, floorHeight);
            }
            if (template.features.includes('office_furniture')) {
                addOfficeFurniture(group, template, floorHeight);
            }
        }

        function createMarbleTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            // Base marble color
            ctx.fillStyle = '#d4d4d4';
            ctx.fillRect(0, 0, 512, 512);
            
            // Add marble veins
            ctx.strokeStyle = '#a0a0a0';
            ctx.lineWidth = 2;
            for (let i = 0; i < 50; i++) {
                ctx.beginPath();
                ctx.moveTo(Math.random() * 512, Math.random() * 512);
                ctx.quadraticCurveTo(
                    Math.random() * 512, Math.random() * 512,
                    Math.random() * 512, Math.random() * 512
                );
                ctx.stroke();
            }
            
            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(4, 4);
            return texture;
        }

        function createTileTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            const tileSize = 128;
            const groutSize = 4;
            
            for (let x = 0; x < 4; x++) {
                for (let y = 0; y < 4; y++) {
                    // Tile
                    ctx.fillStyle = '#e8e8e8';
                    ctx.fillRect(x * tileSize, y * tileSize, tileSize - groutSize, tileSize - groutSize);
                    
                    // Grout
                    ctx.fillStyle = '#c0c0c0';
                    ctx.fillRect(x * tileSize + tileSize - groutSize, y * tileSize, groutSize, tileSize);
                    ctx.fillRect(x * tileSize, y * tileSize + tileSize - groutSize, tileSize, groutSize);
                }
            }
            
            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(8, 8);
            return texture;
        }

        function createWoodTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            // Wood base
            ctx.fillStyle = '#8b4513';
            ctx.fillRect(0, 0, 512, 512);
            
            // Wood grain
            for (let i = 0; i < 100; i++) {
                const y = Math.random() * 512;
                ctx.strokeStyle = `rgba(139, 69, 19, ${Math.random() * 0.3})`;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(512, y + Math.random() * 20 - 10);
                ctx.stroke();
            }
            
            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(2, 2);
            return texture;
        }

        function createWoodPanelingTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            const panelWidth = 128;
            
            for (let x = 0; x < 4; x++) {
                // Panel
                ctx.fillStyle = '#8b6f47';
                ctx.fillRect(x * panelWidth, 0, panelWidth - 4, 512);
                
                // Panel border
                ctx.strokeStyle = '#654321';
                ctx.lineWidth = 2;
                ctx.strokeRect(x * panelWidth + 10, 10, panelWidth - 24, 492);
            }
            
            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(2, 1);
            return texture;
        }

        function addStaircase(group, template, floorHeight) {
            const stairMaterial = new THREE.MeshStandardMaterial({
                color: 0x808080,
                roughness: 0.7,
                metalness: 0.1
            });

            const stairWidth = 3;
            const stairDepth = 0.3;
            const stairHeight = 0.2;
            const numStepsPerFlight = Math.ceil(floorHeight / stairHeight);

            for (let floor = 0; floor < template.floors - 1; floor++) {
                const baseY = floor * floorHeight;

                for (let step = 0; step < numStepsPerFlight; step++) {
                    const stepGeometry = new THREE.BoxGeometry(stairWidth, stairHeight, stairDepth);
                    const stepMesh = new THREE.Mesh(stepGeometry, stairMaterial);
                    stepMesh.position.set(
                        -template.width / 2 + 3,
                        baseY + step * stairHeight,
                        -template.depth / 2 + 2 + step * stairDepth
                    );
                    stepMesh.castShadow = true;
                    stepMesh.receiveShadow = true;
                    group.add(stepMesh);
                }

                // Handrail
                const handrailMaterial = new THREE.MeshStandardMaterial({
                    color: 0x404040,
                    roughness: 0.3,
                    metalness: 0.7
                });
                const handrailGeometry = new THREE.CylinderGeometry(0.05, 0.05, numStepsPerFlight * stairDepth, 16);
                handrailGeometry.rotateX(Math.PI / 2);
                const handrail = new THREE.Mesh(handrailGeometry, handrailMaterial);
                handrail.position.set(
                    -template.width / 2 + 3 + stairWidth / 2,
                    baseY + floorHeight / 2,
                    -template.depth / 2 + 2 + (numStepsPerFlight * stairDepth) / 2
                );
                group.add(handrail);
            }
        }

        function addElevator(group, template, floorHeight) {
            const elevatorMaterial = new THREE.MeshStandardMaterial({
                color: 0xc0c0c0,
                roughness: 0.3,
                metalness: 0.8
            });

            const elevatorWidth = 2.5;
            const elevatorDepth = 2.5;
            const shaftHeight = template.height;

            // Elevator shaft
            const shaftGeometry = new THREE.BoxGeometry(elevatorWidth, shaftHeight, elevatorDepth);
            const shaft = new THREE.Mesh(shaftGeometry, elevatorMaterial);
            shaft.position.set(template.width / 2 - 3, shaftHeight / 2, 0);
            shaft.castShadow = true;
            group.add(shaft);

            // Elevator doors on each floor
            const doorMaterial = new THREE.MeshStandardMaterial({
                color: 0x808080,
                roughness: 0.2,
                metalness: 0.9
            });

            for (let floor = 0; floor < template.floors; floor++) {
                const doorGeometry = new THREE.BoxGeometry(elevatorWidth - 0.2, floorHeight * 0.8, 0.1);
                const door = new THREE.Mesh(doorGeometry, doorMaterial);
                door.position.set(
                    template.width / 2 - 3,
                    floor * floorHeight + floorHeight * 0.4,
                    elevatorDepth / 2 + 0.05
                );
                door.castShadow = true;
                group.add(door);
            }
        }

        // ========== FURNITURE CREATION FUNCTIONS ==========

        function addClassroomFurniture(group, template, floorHeight) {
            // Desk and chair materials
            const deskMaterial = new THREE.MeshStandardMaterial({
                color: 0x8b7355,
                roughness: 0.6,
                metalness: 0.1
            });
            const chairMaterial = new THREE.MeshStandardMaterial({
                color: 0x404040,
                roughness: 0.7,
                metalness: 0.2
            });

            const rows = 6;
            const cols = 8;
            const deskSpacing = 3;

            for (let floor = 0; floor < template.floors; floor++) {
                const y = floor * floorHeight;

                // Student desks and chairs
                for (let row = 0; row < rows; row++) {
                    for (let col = 0; col < cols; col++) {
                        const x = (col - cols / 2 + 0.5) * deskSpacing;
                        const z = (row - rows / 2 + 0.5) * deskSpacing;

                        // Desk
                        const desk = new THREE.Group();
                        const deskTop = new THREE.Mesh(
                            new THREE.BoxGeometry(1.2, 0.1, 0.8),
                            deskMaterial
                        );
                        deskTop.position.y = 0.75;
                        desk.add(deskTop);

                        // Desk legs
                        for (let i = 0; i < 4; i++) {
                            const legX = (i % 2) * 0.5 - 0.25;
                            const legZ = Math.floor(i / 2) * 0.6 - 0.3;
                            const leg = new THREE.Mesh(
                                new THREE.CylinderGeometry(0.03, 0.03, 0.7, 8),
                                deskMaterial
                            );
                            leg.position.set(legX, 0.35, legZ);
                            desk.add(leg);
                        }

                        desk.position.set(x, y + 0.5, z);
                        desk.castShadow = true;
                        desk.receiveShadow = true;
                        group.add(desk);

                        // Chair
                        const chair = new THREE.Group();
                        const seat = new THREE.Mesh(
                            new THREE.BoxGeometry(0.5, 0.05, 0.5),
                            chairMaterial
                        );
                        seat.position.y = 0.45;
                        chair.add(seat);

                        const backrest = new THREE.Mesh(
                            new THREE.BoxGeometry(0.5, 0.5, 0.05),
                            chairMaterial
                        );
                        backrest.position.set(0, 0.7, -0.2);
                        chair.add(backrest);

                        chair.position.set(x, y + 0.5, z + 0.6);
                        chair.castShadow = true;
                        group.add(chair);
                    }
                }

                // Whiteboard at front
                const whiteboardMaterial = new THREE.MeshStandardMaterial({
                    color: 0xffffff,
                    roughness: 0.2,
                    metalness: 0.1
                });
                const whiteboard = new THREE.Mesh(
                    new THREE.BoxGeometry(6, 2.5, 0.1),
                    whiteboardMaterial
                );
                whiteboard.position.set(0, y + 2.5, -template.depth / 2 + 1.5);
                whiteboard.castShadow = true;
                group.add(whiteboard);

                // Teacher's desk
                const teacherDesk = new THREE.Mesh(
                    new THREE.BoxGeometry(2, 0.8, 1.2),
                    deskMaterial
                );
                teacherDesk.position.set(4, y + 0.9, -template.depth / 2 + 2.5);
                teacherDesk.castShadow = true;
                group.add(teacherDesk);
            }
        }

        function addLibraryFurniture(group, template, floorHeight) {
            const shelfMaterial = new THREE.MeshStandardMaterial({
                color: 0x654321,
                roughness: 0.7,
                metalness: 0.0
            });
            const sofaMaterial = new THREE.MeshStandardMaterial({
                color: 0x8b4513,
                roughness: 0.8,
                metalness: 0.0
            });

            for (let floor = 0; floor < template.floors; floor++) {
                const y = floor * floorHeight;

                // Bookshelves
                const numShelves = 8;
                for (let i = 0; i < numShelves; i++) {
                    const bookshelf = new THREE.Group();
                    
                    // Shelves (5 levels)
                    for (let shelf = 0; shelf < 5; shelf++) {
                        const shelfPlank = new THREE.Mesh(
                            new THREE.BoxGeometry(3, 0.05, 0.8),
                            shelfMaterial
                        );
                        shelfPlank.position.y = shelf * 0.6;
                        bookshelf.add(shelfPlank);
                    }

                    // Side panels
                    const sidePanel1 = new THREE.Mesh(
                        new THREE.BoxGeometry(0.05, 2.4, 0.8),
                        shelfMaterial
                    );
                    sidePanel1.position.set(-1.5, 1.2, 0);
                    bookshelf.add(sidePanel1);

                    const sidePanel2 = sidePanel1.clone();
                    sidePanel2.position.x = 1.5;
                    bookshelf.add(sidePanel2);

                    // Books
                    for (let shelf = 0; shelf < 5; shelf++) {
                        for (let book = 0; book < 15; book++) {
                            const bookMaterial = new THREE.MeshStandardMaterial({
                                color: Math.random() * 0xffffff,
                                roughness: 0.8
                            });
                            const bookMesh = new THREE.Mesh(
                                new THREE.BoxGeometry(0.15, 0.5, 0.7),
                                bookMaterial
                            );
                            bookMesh.position.set(
                                (book - 7.5) * 0.2,
                                shelf * 0.6 + 0.3,
                                0
                            );
                            bookshelf.add(bookMesh);
                        }
                    }

                    const x = ((i % 4) - 1.5) * 8;
                    const z = Math.floor(i / 4) * 10 - 5;
                    bookshelf.position.set(x, y + 0.5, z);
                    bookshelf.castShadow = true;
                    group.add(bookshelf);
                }

                // Reading area with sofas
                for (let i = 0; i < 4; i++) {
                    const sofa = new THREE.Group();
                    
                    // Sofa base
                    const base = new THREE.Mesh(
                        new THREE.BoxGeometry(2, 0.5, 1),
                        sofaMaterial
                    );
                    base.position.y = 0.5;
                    sofa.add(base);

                    // Backrest
                    const backrest = new THREE.Mesh(
                        new THREE.BoxGeometry(2, 1, 0.2),
                        sofaMaterial
                    );
                    backrest.position.set(0, 1, -0.4);
                    sofa.add(backrest);

                    // Armrests
                    const armrest1 = new THREE.Mesh(
                        new THREE.BoxGeometry(0.2, 0.6, 1),
                        sofaMaterial
                    );
                    armrest1.position.set(-1, 0.8, 0);
                    sofa.add(armrest1);

                    const armrest2 = armrest1.clone();
                    armrest2.position.x = 1;
                    sofa.add(armrest2);

                    const angle = (i / 4) * Math.PI * 2;
                    const radius = 8;
                    sofa.position.set(
                        Math.cos(angle) * radius,
                        y + 0.5,
                        Math.sin(angle) * radius
                    );
                    sofa.rotation.y = angle + Math.PI / 2;
                    sofa.castShadow = true;
                    group.add(sofa);
                }

                // Study tables
                const tableMaterial = new THREE.MeshStandardMaterial({
                    color: 0x8b7355,
                    roughness: 0.6
                });
                for (let i = 0; i < 6; i++) {
                    const table = new THREE.Mesh(
                        new THREE.BoxGeometry(2, 0.1, 1.5),
                        tableMaterial
                    );
                    table.position.set(
                        ((i % 3) - 1) * 6,
                        y + 0.75,
                        Math.floor(i / 3) * 6
                    );
                    table.castShadow = true;
                    group.add(table);
                }
            }
        }

        function addLabFurniture(group, template, floorHeight) {
            const labTableMaterial = new THREE.MeshStandardMaterial({
                color: 0x2a2a2a,
                roughness: 0.3,
                metalness: 0.7
            });

            for (let floor = 0; floor < template.floors; floor++) {
                const y = floor * floorHeight;

                // Lab benches
                const numBenches = 6;
                for (let i = 0; i < numBenches; i++) {
                    const bench = new THREE.Group();
                    
                    // Table top
                    const top = new THREE.Mesh(
                        new THREE.BoxGeometry(4, 0.1, 1.5),
                        labTableMaterial
                    );
                    top.position.y = 0.9;
                    bench.add(top);

                    // Sink
                    const sink = new THREE.Mesh(
                        new THREE.BoxGeometry(0.5, 0.2, 0.5),
                        new THREE.MeshStandardMaterial({ color: 0xaaaaaa, roughness: 0.2, metalness: 0.9 })
                    );
                    sink.position.set(1.5, 0.95, 0);
                    bench.add(sink);

                    // Gas burner
                    const burner = new THREE.Mesh(
                        new THREE.CylinderGeometry(0.15, 0.15, 0.1, 16),
                        new THREE.MeshStandardMaterial({ color: 0x4a4a4a, roughness: 0.4, metalness: 0.8 })
                    );
                    burner.position.set(-1.5, 1, 0);
                    bench.add(burner);

                    // Lab equipment (beakers, flasks)
                    for (let j = 0; j < 3; j++) {
                        const beaker = new THREE.Mesh(
                            new THREE.CylinderGeometry(0.08, 0.1, 0.3, 16),
                            new THREE.MeshStandardMaterial({
                                color: 0x88ccff,
                                roughness: 0.1,
                                metalness: 0.1,
                                transparent: true,
                                opacity: 0.6
                            })
                        );
                        beaker.position.set((j - 1) * 0.4, 1.15, 0.3);
                        bench.add(beaker);
                    }

                    const x = ((i % 2) - 0.5) * 10;
                    const z = Math.floor(i / 2) * 6 - 6;
                    bench.position.set(x, y + 0.5, z);
                    bench.castShadow = true;
                    group.add(bench);

                    // Lab stools
                    for (let s = 0; s < 4; s++) {
                        const stool = new THREE.Mesh(
                            new THREE.CylinderGeometry(0.3, 0.25, 0.6, 16),
                            new THREE.MeshStandardMaterial({ color: 0x404040, roughness: 0.7 })
                        );
                        stool.position.set(
                            x + (s - 1.5) * 1,
                            y + 0.8,
                            z + 1.2
                        );
                        stool.castShadow = true;
                        group.add(stool);
                    }
                }

                // Fume hoods
                const fumeHoodMaterial = new THREE.MeshStandardMaterial({
                    color: 0xcccccc,
                    roughness: 0.4,
                    metalness: 0.3
                });
                for (let i = 0; i < 2; i++) {
                    const hood = new THREE.Mesh(
                        new THREE.BoxGeometry(2.5, 2, 1.5),
                        fumeHoodMaterial
                    );
                    hood.position.set(
                        (i - 0.5) * 15,
                        y + 1.5,
                        -template.depth / 2 + 2
                    );
                    hood.castShadow = true;
                    group.add(hood);
                }
            }
        }

        function addComputerLabFurniture(group, template, floorHeight) {
            const deskMaterial = new THREE.MeshStandardMaterial({
                color: 0x505050,
                roughness: 0.5,
                metalness: 0.3
            });
            const monitorMaterial = new THREE.MeshStandardMaterial({
                color: 0x1a1a1a,
                roughness: 0.3,
                metalness: 0.7
            });

            for (let floor = 0; floor < template.floors; floor++) {
                const y = floor * floorHeight;

                // Computer stations
                const rows = 4;
                const cols = 6;
                const spacing = 3;

                for (let row = 0; row < rows; row++) {
                    for (let col = 0; col < cols; col++) {
                        const station = new THREE.Group();
                        
                        // Desk
                        const desk = new THREE.Mesh(
                            new THREE.BoxGeometry(1.5, 0.75, 1),
                            deskMaterial
                        );
                        station.add(desk);

                        // Monitor
                        const monitor = new THREE.Mesh(
                            new THREE.BoxGeometry(1, 0.7, 0.05),
                            monitorMaterial
                        );
                        monitor.position.set(0, 0.85, -0.3);
                        monitor.rotation.x = -0.1;
                        station.add(monitor);

                        // Monitor stand
                        const stand = new THREE.Mesh(
                            new THREE.CylinderGeometry(0.1, 0.15, 0.2, 16),
                            monitorMaterial
                        );
                        stand.position.set(0, 0.475, -0.3);
                        station.add(stand);

                        // Keyboard
                        const keyboard = new THREE.Mesh(
                            new THREE.BoxGeometry(0.6, 0.02, 0.25),
                            new THREE.MeshStandardMaterial({ color: 0x2a2a2a, roughness: 0.6 })
                        );
                        keyboard.position.set(0, 0.4, 0.1);
                        station.add(keyboard);

                        // Mouse
                        const mouse = new THREE.Mesh(
                            new THREE.BoxGeometry(0.08, 0.04, 0.12),
                            new THREE.MeshStandardMaterial({ color: 0x3a3a3a, roughness: 0.5 })
                        );
                        mouse.position.set(0.4, 0.4, 0.1);
                        station.add(mouse);

                        // Chair
                        const chair = new THREE.Mesh(
                            new THREE.CylinderGeometry(0.3, 0.25, 0.6, 16),
                            new THREE.MeshStandardMaterial({ color: 0x404040, roughness: 0.7 })
                        );
                        chair.position.set(0, 0.3, 0.8);
                        station.add(chair);

                        const x = (col - cols / 2 + 0.5) * spacing;
                        const z = (row - rows / 2 + 0.5) * spacing;
                        station.position.set(x, y + 0.5, z);
                        station.castShadow = true;
                        group.add(station);
                    }
                }

                // Server rack
                const serverMaterial = new THREE.MeshStandardMaterial({
                    color: 0x2a2a2a,
                    roughness: 0.4,
                    metalness: 0.8,
                    emissive: 0x00ff00,
                    emissiveIntensity: 0.2
                });
                const server = new THREE.Mesh(
                    new THREE.BoxGeometry(1, 2, 0.8),
                    serverMaterial
                );
                server.position.set(template.width / 2 - 3, y + 1.5, -template.depth / 2 + 2);
                server.castShadow = true;
                group.add(server);
            }
        }

        function addOfficeFurniture(group, template, floorHeight) {
            const deskMaterial = new THREE.MeshStandardMaterial({
                color: 0x8b7355,
                roughness: 0.6,
                metalness: 0.1
            });

            for (let floor = 0; floor < template.floors; floor++) {
                const y = floor * floorHeight;

                // Reception desk
                const reception = new THREE.Mesh(
                    new THREE.BoxGeometry(4, 1.2, 2),
                    deskMaterial
                );
                reception.position.set(0, y + 1.1, -template.depth / 2 + 4);
                reception.castShadow = true;
                group.add(reception);

                // Waiting area sofas
                for (let i = 0; i < 3; i++) {
                    const sofa = new THREE.Group();
                    
                    const base = new THREE.Mesh(
                        new THREE.BoxGeometry(2.5, 0.5, 1),
                        new THREE.MeshStandardMaterial({ color: 0x4a6fa5, roughness: 0.8 })
                    );
                    base.position.y = 0.5;
                    sofa.add(base);

                    const backrest = new THREE.Mesh(
                        new THREE.BoxGeometry(2.5, 0.8, 0.2),
                        new THREE.MeshStandardMaterial({ color: 0x4a6fa5, roughness: 0.8 })
                    );
                    backrest.position.set(0, 0.9, -0.4);
                    sofa.add(backrest);

                    sofa.position.set((i - 1) * 3.5, y + 0.5, 0);
                    sofa.castShadow = true;
                    group.add(sofa);
                }

                // Coffee table
                const coffeeTable = new THREE.Mesh(
                    new THREE.BoxGeometry(1.5, 0.5, 1),
                    new THREE.MeshStandardMaterial({ color: 0x654321, roughness: 0.5 })
                );
                coffeeTable.position.set(0, y + 0.75, 2);
                coffeeTable.castShadow = true;
                group.add(coffeeTable);

                // Office cubicles
                const numCubicles = 8;
                for (let i = 0; i < numCubicles; i++) {
                    const cubicle = new THREE.Group();
                    
                    // Desk
                    const desk = new THREE.Mesh(
                        new THREE.BoxGeometry(1.5, 0.75, 1.2),
                        deskMaterial
                    );
                    cubicle.add(desk);

                    // Divider walls
                    const wallMaterial = new THREE.MeshStandardMaterial({
                        color: 0xcccccc,
                        roughness: 0.8
                    });
                    const wall1 = new THREE.Mesh(
                        new THREE.BoxGeometry(0.05, 1.5, 1.2),
                        wallMaterial
                    );
                    wall1.position.set(-0.75, 0.75, 0);
                    cubicle.add(wall1);

                    const wall2 = new THREE.Mesh(
                        new THREE.BoxGeometry(1.5, 1.5, 0.05),
                        wallMaterial
                    );
                    wall2.position.set(0, 0.75, -0.6);
                    cubicle.add(wall2);

                    // Office chair
                    const chair = new THREE.Mesh(
                        new THREE.CylinderGeometry(0.3, 0.25, 0.6, 16),
                        new THREE.MeshStandardMaterial({ color: 0x404040, roughness: 0.7 })
                    );
                    chair.position.set(0, 0.3, 0.5);
                    cubicle.add(chair);

                    const x = ((i % 4) - 1.5) * 4;
                    const z = Math.floor(i / 4) * 6 + 5;
                    cubicle.position.set(x, y + 0.5, z);
                    cubicle.castShadow = true;
                    group.add(cubicle);
                }
            }
        }

        function addWindows(group, template) {
            const windowMaterial = new THREE.MeshStandardMaterial({
                color: 0x2a4a6a,
                roughness: 0.1,
                metalness: 0.9,
                emissive: 0x1a3a5a,
                emissiveIntensity: 0.3
            });

            const windowWidth = 2;
            const windowHeight = 2.5;
            const windowDepth = 0.3;
            const floorHeight = template.height / template.floors;

            // Front and back windows
            for (let floor = 0; floor < template.floors; floor++) {
                const y = floorHeight * (floor + 0.5);
                const numWindowsWidth = Math.floor(template.width / 4);

                for (let i = 0; i < numWindowsWidth; i++) {
                    const x = (i - numWindowsWidth / 2 + 0.5) * 4;

                    // Front windows
                    const frontWindow = new THREE.Mesh(
                        new THREE.BoxGeometry(windowWidth, windowHeight, windowDepth),
                        windowMaterial
                    );
                    frontWindow.position.set(x, y, template.depth / 2 + windowDepth / 2);
                    frontWindow.castShadow = true;
                    group.add(frontWindow);

                    // Back windows
                    const backWindow = frontWindow.clone();
                    backWindow.position.z = -template.depth / 2 - windowDepth / 2;
                    group.add(backWindow);
                }
            }

            // Side windows
            for (let floor = 0; floor < template.floors; floor++) {
                const y = floorHeight * (floor + 0.5);
                const numWindowsDepth = Math.floor(template.depth / 4);

                for (let i = 0; i < numWindowsDepth; i++) {
                    const z = (i - numWindowsDepth / 2 + 0.5) * 4;

                    // Left windows
                    const leftWindow = new THREE.Mesh(
                        new THREE.BoxGeometry(windowDepth, windowHeight, windowWidth),
                        windowMaterial
                    );
                    leftWindow.position.set(-template.width / 2 - windowDepth / 2, y, z);
                    leftWindow.castShadow = true;
                    group.add(leftWindow);

                    // Right windows
                    const rightWindow = leftWindow.clone();
                    rightWindow.position.x = template.width / 2 + windowDepth / 2;
                    group.add(rightWindow);
                }
            }
        }

        function addEntrance(group, template) {
            const doorMaterial = new THREE.MeshStandardMaterial({
                color: 0x4a3020,
                roughness: 0.7,
                metalness: 0.2
            });

            const doorWidth = 4;
            const doorHeight = 5;
            const doorDepth = 0.3;

            const door = new THREE.Mesh(
                new THREE.BoxGeometry(doorWidth, doorHeight, doorDepth),
                doorMaterial
            );
            door.position.set(0, doorHeight / 2, template.depth / 2 + doorDepth / 2);
            door.castShadow = true;
            group.add(door);

            // Entrance overhang
            const overhangMaterial = new THREE.MeshStandardMaterial({
                color: template.color,
                roughness: 0.8,
                metalness: 0.1
            });
            const overhang = new THREE.Mesh(
                new THREE.BoxGeometry(doorWidth + 4, 0.5, 3),
                overhangMaterial
            );
            overhang.position.set(0, doorHeight + 1, template.depth / 2 + 1.5);
            overhang.castShadow = true;
            group.add(overhang);

            // Steps
            if (template.features.includes('entrance_steps')) {
                const stepMaterial = new THREE.MeshStandardMaterial({
                    color: 0x808080,
                    roughness: 0.9,
                    metalness: 0.1
                });

                for (let i = 0; i < 3; i++) {
                    const step = new THREE.Mesh(
                        new THREE.BoxGeometry(doorWidth + 2, 0.3, 0.8),
                        stepMaterial
                    );
                    step.position.set(0, i * 0.3, template.depth / 2 + 1 + i * 0.8);
                    step.castShadow = true;
                    step.receiveShadow = true;
                    group.add(step);
                }
            }
        }

        function addRoof(group, template) {
            const roofMaterial = new THREE.MeshStandardMaterial({
                color: 0x505050,
                roughness: 0.9,
                metalness: 0.1
            });

            switch (template.roofType) {
                case 'flat_modern':
                    const flatRoof = new THREE.Mesh(
                        new THREE.BoxGeometry(template.width + 2, 0.8, template.depth + 2),
                        roofMaterial
                    );
                    flatRoof.position.y = template.height + 0.4;
                    flatRoof.castShadow = true;
                    group.add(flatRoof);
                    break;

                case 'sloped':
                    const slopeGeometry = new THREE.ConeGeometry(template.width * 0.7, 5, 4);
                    slopeGeometry.rotateY(Math.PI / 4);
                    const slopedRoof = new THREE.Mesh(slopeGeometry, roofMaterial);
                    slopedRoof.position.y = template.height + 2.5;
                    slopedRoof.castShadow = true;
                    group.add(slopedRoof);
                    break;

                case 'peaked':
                    const peakGeometry = new THREE.ConeGeometry(template.width * 0.6, 6, 4);
                    const peakedRoof = new THREE.Mesh(peakGeometry, roofMaterial);
                    peakedRoof.position.y = template.height + 3;
                    peakedRoof.castShadow = true;
                    group.add(peakedRoof);
                    break;

                case 'domed':
                    const domeGeometry = new THREE.SphereGeometry(template.width * 0.4, 32, 16, 0, Math.PI * 2, 0, Math.PI / 2);
                    const dome = new THREE.Mesh(domeGeometry, roofMaterial);
                    dome.position.y = template.height;
                    dome.castShadow = true;
                    group.add(dome);
                    break;

                case 'spire':
                    const spireGeometry = new THREE.ConeGeometry(3, 15, 8);
                    const spire = new THREE.Mesh(spireGeometry, roofMaterial);
                    spire.position.y = template.height + 7.5;
                    spire.castShadow = true;
                    group.add(spire);
                    break;
            }
        }

        function addColumns(group, template) {
            const columnMaterial = new THREE.MeshStandardMaterial({
                color: 0xf0f0f0,
                roughness: 0.6,
                metalness: 0.2
            });

            const columnRadius = 0.8;
            const columnHeight = template.height * 0.6;
            const numColumns = 6;

            for (let i = 0; i < numColumns; i++) {
                const x = (i - (numColumns - 1) / 2) * (template.width / (numColumns + 1));
                const column = new THREE.Mesh(
                    new THREE.CylinderGeometry(columnRadius, columnRadius, columnHeight, 16),
                    columnMaterial
                );
                column.position.set(x, columnHeight / 2, template.depth / 2 + 2);
                column.castShadow = true;
                group.add(column);
            }
        }

        function addBuilding(type) {
            const template = buildingTemplates[type];
            if (!template) {
                console.error('Unknown building type:', type);
                return;
            }

            // Random position in a grid-like pattern
            const gridSize = 80;
            const gridX = Math.floor(Math.random() * 5) - 2;
            const gridZ = Math.floor(Math.random() * 5) - 2;
            const position = new THREE.Vector3(gridX * gridSize, 0, gridZ * gridSize);

            createBuilding(template, position);
            console.log(`Added ${template.name} at position (${position.x}, ${position.y}, ${position.z})`);
        }

        function generateFullCampus() {
            clearScene();

            // Central quad
            const campusLayout = [
                { type: 'library', position: new THREE.Vector3(0, 0, 0) },
                { type: 'admin', position: new THREE.Vector3(-60, 0, 0) },
                { type: 'student_union', position: new THREE.Vector3(60, 0, 0) },
                { type: 'lecture', position: new THREE.Vector3(-60, 0, -60) },
                { type: 'science', position: new THREE.Vector3(0, 0, -60) },
                { type: 'computer', position: new THREE.Vector3(60, 0, -60) },
                { type: 'cafeteria', position: new THREE.Vector3(-60, 0, 60) },
                { type: 'gym', position: new THREE.Vector3(0, 0, 60) },
                { type: 'theater', position: new THREE.Vector3(60, 0, 60) },
                { type: 'arts', position: new THREE.Vector3(-120, 0, 0) },
                { type: 'engineering', position: new THREE.Vector3(120, 0, 0) },
                { type: 'dorm', position: new THREE.Vector3(-120, 0, -60) },
                { type: 'dorm', position: new THREE.Vector3(-120, 0, 60) },
                { type: 'parking', position: new THREE.Vector3(120, 0, -60) },
                { type: 'clock_tower', position: new THREE.Vector3(0, 0, -120) },
                { type: 'fountain', position: new THREE.Vector3(0, 0, -30) }
            ];

            campusLayout.forEach(item => {
                const template = buildingTemplates[item.type];
                createBuilding(template, item.position);
            });

            console.log('Full campus generated with', campusLayout.length, 'buildings');
        }

        function clearScene() {
            buildings.forEach(building => {
                scene.remove(building.group);
            });
            buildings = [];
            updateStats();
            console.log('Scene cleared');
        }

        function exportScene() {
            const exportData = {
                buildings: buildings.map(building => ({
                    type: building.template.name,
                    position: {
                        x: building.position.x,
                        y: building.position.y,
                        z: building.position.z
                    },
                    dimensions: {
                        width: building.template.width,
                        height: building.template.height,
                        depth: building.template.depth
                    }
                })),
                metadata: {
                    totalBuildings: buildings.length,
                    exportDate: new Date().toISOString(),
                    generator: 'College Building Library v1.0'
                }
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'campus_layout_' + Date.now() + '.json';
            link.click();

            console.log('Exported', buildings.length, 'buildings to JSON');
        }

        // Make functions global so onclick handlers can access them
        window.addBuilding = addBuilding;
        window.generateFullCampus = generateFullCampus;
        window.clearScene = clearScene;
        window.exportScene = exportScene;

        function updateStats() {
            document.getElementById('building-count').textContent = buildings.length;
            
            let totalVertices = 0;
            let totalTriangles = 0;
            
            buildings.forEach(building => {
                building.group.traverse(child => {
                    if (child.geometry) {
                        const positions = child.geometry.attributes.position;
                        if (positions) {
                            totalVertices += positions.count;
                            if (child.geometry.index) {
                                totalTriangles += child.geometry.index.count / 3;
                            } else {
                                totalTriangles += positions.count / 3;
                            }
                        }
                    }
                });
            });

            document.getElementById('vertex-count').textContent = totalVertices.toLocaleString();
            document.getElementById('triangle-count').textContent = Math.floor(totalTriangles).toLocaleString();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            updateFirstPersonMovement();
            renderer.render(scene, camera);
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
